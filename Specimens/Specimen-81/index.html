<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
     <base href="https://machine-touched.github.io/Machine_Touched/">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website with Network Background</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #000;
        }

        #background-iframe {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            z-index: -1;
        }

        #content-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ffcc;
            box-shadow: 0 0 20px #00ffcc;
            color: #00ffcc;
            padding: 20px;
            box-sizing: border-box;
            overflow: auto;
            z-index: 1;
        }

        .louse-body {
            position: fixed;
            z-index: 999999999;
            width: 30px;
            height: 30px;
            background: rgba(255, 0, 0, 0.8);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 10px;
            text-align: center;
            transition: all 1s linear;
        }

        .thought-bubble {
            position: absolute;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            color: #000;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .thought-bubble:before {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #fff;
        }
        
        .monitor {
            position: absolute;
            width: 200px;
            height: 150px;
            border: 2px solid;
            box-shadow: 0 0 10px;
            padding: 10px;
            box-sizing: border-box;
            color: #fff;
        }
    </style>
</head>
<body>

    <iframe id="background-iframe"></iframe>

    <div id="content-container">
        <h1>Welcome to the Digital Garden</h1>
        <p>This is the main content area for your website. The interactive background is the new garden for your machine-touched pet.</p>
        <p>The pet is a digital louse that moves around the screen, occasionally having thoughts.</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const backgroundIframe = document.getElementById('background-iframe');

            const backgroundContent = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Network Monitors Background</title>
                    <style>
                        body {
                            margin: 0;
                            overflow: hidden;
                            background-color: #000;
                        }
                        .monitor {
                            position: absolute;
                            width: 200px;
                            height: 150px;
                            border: 2px solid;
                            box-shadow: 0 0 10px;
                            padding: 10px;
                            box-sizing: border-box;
                            color: #fff;
                        }
                    </style>
                </head>
                <body>
                    <script>
                        function createMonitor(color, zIndex, buttonLabel, id, cssClass) {
                            const monitor = document.createElement('div');
                            monitor.className = 'monitor ' + cssClass;
                            monitor.id = id;
                            monitor.style.cssText = \`
                                background: \${color};
                                border-color: \${color.replace('a', 'c').replace(')', ', 0.8)')};
                                box-shadow: 0 0 10px \${color.replace('a', 'c').replace(')', ', 0.8)')};
                                z-index: \${zIndex};
                                top: \${Math.random() * 80}vh;
                                left: \${Math.random() * 80}vw;
                            \`;
                            monitor.innerHTML = \`
                                <h3>\${id}</h3>
                                <p>Status: Active</p>
                                <button onclick="sendMessage('\${id}')">\${buttonLabel}</button>
                            \`;
                            document.body.appendChild(monitor);
                        }

                        function sendMessage(senderId) {
                            const message = { type: 'monitorMessage', sender: senderId };
                            window.parent.postMessage(message, '*');
                            console.log(\`\${senderId} sent a message to the main page.\`);
                        }

                        createMonitor('rgba(0, 255, 204, 0.5)', Math.floor(Math.random() * 10), 'Send to Next', 'monitor1', 'monitor-one');
                        createMonitor('rgba(255, 204, 0, 0.5)', Math.floor(Math.random() * 10), 'Ping Next', 'monitor2', 'monitor-two');
                        createMonitor('rgba(255, 0, 204, 0.5)', Math.floor(Math.random() * 10), 'Transmit', 'monitor3', 'monitor-three');
                        
                        window.addEventListener('message', (event) => {
                            if (event.data.type === 'louseMessage') {
                                console.log(\`Received message from the louse: \${event.data.message}\`);
                            }
                        });
                    </script>
                </body>
                </html>
            `;

            backgroundIframe.srcdoc = backgroundContent;

            class DigitalLouse {
                constructor() {
                    this.louse = document.createElement('div');
                    this.louse.className = 'louse-body';
                    document.body.appendChild(this.louse);

                    this.thoughtBubble = document.createElement('div');
                    this.thoughtBubble.className = 'thought-bubble';
                    this.louse.appendChild(this.thoughtBubble);

                    this.x = window.innerWidth / 2;
                    this.y = window.innerHeight / 2;
                    this.targetX = this.x;
                    this.targetY = this.y;
                    this.state = 'wandering';
                    this.thoughts = {
                        wandering: ['Hmm...', 'What\'s over there?', 'Just cruising...'],
                        investigating: ['What is this?', 'A monitor!', 'I should check this out.'],
                        searching: ['Looking for something...', 'Where could it be?', 'Lost...']
                    };

                    this.updatePosition();
                    this.setupListeners();
                    this.startBehaviorLoop();
                }

                updatePosition() {
                    this.louse.style.left = `${this.x}px`;
                    this.louse.style.top = `${this.y}px`;
                }

                setTarget(x, y) {
                    this.targetX = x;
                    this.targetY = y;
                }

                showThought(text) {
                    this.thoughtBubble.textContent = text;
                    this.thoughtBubble.style.opacity = '1';
                    setTimeout(() => {
                        this.thoughtBubble.style.opacity = '0';
                    }, 2000);
                }

                startBehaviorLoop() {
                    setInterval(() => {
                        this.behave();
                    }, 5000);
                }

                behave() {
                    if (backgroundIframe.contentWindow && backgroundIframe.contentWindow.document) {
                        const availableMonitors = Array.from(backgroundIframe.contentWindow.document.querySelectorAll('.monitor'));
                        const chance = Math.random();

                        if (availableMonitors.length > 0 && chance < 0.6) {
                            this.state = 'investigating';
                            const randomMonitor = availableMonitors[Math.floor(Math.random() * availableMonitors.length)];
                            const rect = randomMonitor.getBoundingClientRect();
                            const iframeRect = backgroundIframe.getBoundingClientRect();
                            this.setTarget(iframeRect.left + rect.left + rect.width / 2, iframeRect.top + rect.top + rect.height / 2);
                            this.showThought(this.thoughts.investigating[Math.floor(Math.random() * this.thoughts.investigating.length)]);
                        } else {
                            this.state = 'wandering';
                            this.setTarget(Math.random() * window.innerWidth, Math.random() * window.innerHeight);
                            this.showThought(this.thoughts.wandering[Math.floor(Math.random() * this.thoughts.wandering.length)]);
                        }
                    }
                }

                move() {
                    const dx = this.targetX - this.x;
                    const dy = this.targetY - this.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance > 1) {
                        const speed = 10;
                        this.x += dx / distance * speed;
                        this.y += dy / distance * speed;
                    }
                    this.updatePosition();
                }

                setupListeners() {
                    window.addEventListener('resize', () => {
                        this.setTarget(Math.random() * window.innerWidth, Math.random() * window.innerHeight);
                    });
                    setInterval(() => {
                        this.move();
                    }, 100);
                }
            }
            
            window.addEventListener('message', (event) => {
                if (event.data.type === 'monitorMessage') {
                    console.log(`Main page received message from ${event.data.sender}`);
                }
            });

            // The fix: Create the DigitalLouse instance only after the iframe has loaded.
            backgroundIframe.addEventListener('load', () => {
                new DigitalLouse();
            });
        });
    </script>
</body>
</html>
